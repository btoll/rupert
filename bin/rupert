#!/usr/bin/env node
/* eslint-disable no-console */
'use strict';

const logger = require('logger'),
    argv = require('yargs')
    .usage('Usage: rupert [options]')

    .alias('f', 'file')
    .nargs('f', 1)
    .describe('f', 'The file to analyze')

    .describe('flags', 'Specifies which types are captured')

    .describe('html', 'Creates an html document of the analysis')
    .boolean('html')

    .alias('v', 'debug')
    .boolean('v')
    .describe('v', 'Turns on verbose debug logging')

    .help('h')
    .argv,

    // Default to printing to stdout.
    generator = require(`s/src/generator/${!argv.html ? 'log' : 'html'}`),
    visitor = require('../src/visitor'),
    h = require('s/src/index'),
    file = argv.file,
    flags = Number(argv.flags),
    // TODO
    log = console.log,
    error = logger.error;

visitor.setFlags(
    flags != null ?
    flags :
    255
);

// Logging is enabled by default.
if (!argv.v) {
    logger.disable();
}

// Mixin our node type functions.
h.register(visitor);

if (!file) {
    const stdin = process.stdin;
    let buf = '';

    stdin.setEncoding('utf8');

    stdin.on('readable', () => {
        const chunk = stdin.read();

        if (chunk !== null) {
            buf += chunk;
        }
    });

    stdin.on('end', () => {
        h.makeTree(buf, generator, true)
        .then(log)
        .catch(error);
    });
} else {
    h.makeTree(file, generator, argv.verbose, false)
    .then(log)
    .catch(error);
}

