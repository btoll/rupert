#!/usr/bin/env node
'use strict';

const fs = require('fs'),
    glob = require('glob'),
    logger = require('logger'),
    argv = require('yargs')
    .usage('Usage: rupert [options]')

    .describe('bitmask', 'The bitmask which determines the nodes to be captured')
    .alias('bitmask', 'b')
    .nargs('bitmask', 1)

    .describe('debug', 'Turns on debug logging')
    .alias('debug', 'd')
    .boolean('debug')

    .describe('html', 'Creates an html document of the analysis')
    .boolean('html')

    .describe('target', 'The target to analyze')
    .alias('target', 't')
    .nargs('target', 1)

    .describe('verbose', 'Show code snippets')
    .alias('verbose', 'v')
    .boolean('v')

    .help('help')
    .alias('help', 'h')

    .group([
        'FunctionNesting: 1',
        'ImpureFunction: 2',
        'NoLoops: 4',
        'UnnecessaryBraces: 8'
    ], 'Rules:')
    .argv,

    // Default to raw.
    generator = require(
        `s/src/generator/${
            argv.html ? 'html' :
                argv.v ? 'log' :
                'raw'
        }`
    ),
    visitor = require('../src/visitor'),
    h = require('s'),
    target = argv.target,
    bitmask = Number(argv.bitmask);

visitor.setBitmask(
    !isNaN(bitmask) ?
        bitmask :
        255
);

// Mixin our node type functions.
h.register(visitor);

if (!target) {
    const stdin = process.stdin;
    let buf = '';

    stdin.setEncoding('utf8');

    stdin.on('readable', () => {
        const chunk = stdin.read();

        if (chunk !== null) {
            buf += chunk;
        }
    });

    stdin.on('end', () => {
        h.makeTree(buf, generator, true)
        .then(logger.raw)
        .catch(logger.error);
    });
} else {
    fs.stat(target, (err, stats) => {
        if (err) {
            logger.error('There was a problem accessing the target!');
        } else {
            if (stats.isFile()) {
                h.makeTree(target, generator, false)
                .then(logger.raw)
                .catch(logger.error);
            } else {
                glob(`${target}/*.js`, (err, files) => {
                    if (err) {
                        logger.error('There was a problem globbing the files!');
                    } else {
                        files.forEach(file =>
                            h.makeTree(file, generator, false)
                            .then(data =>
                                (logger.info(`Processing file ${file}`), logger.raw(`${data}`))
                            )
                            .catch(logger.error)
                        );
                    }
                });
            }
        }
    });
}

